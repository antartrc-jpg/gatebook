<!doctype html>
<meta charset="utf-8"/>
<title>Gatebook â€“ Recent Files</title>
<style>
  body{font-family:system-ui;margin:2rem}
  table{border-collapse:collapse}
  td,th{padding:.4rem .6rem;border:1px solid #ddd}
  button{padding:.2rem .5rem}
  .chip{padding:.1rem .4rem;border-radius:.5rem;border:1px solid #ccc}
</style>
<h1>Recent Files</h1>
<table id="t">
  <thead>
    <tr><th>When</th><th>Name</th><th>Size</th><th>Type</th><th>Link</th><th>Retention</th><th>Actions</th></tr>
  </thead>
  <tbody></tbody>
</table>
<pre id="err" style="color:#900"></pre>
<script>
const fmt=(b)=> b!=null? new Intl.NumberFormat().format(b) : '';

async function load(){
  try{
    const rows = await fetch('http://localhost:8081/files/recent2')
      .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
    const tb=document.querySelector('#t tbody');
    tb.innerHTML='';
    if(!rows.length){ tb.innerHTML = '<tr><td colspan="7">keine Daten</td></tr>'; return; }
    for(const r of rows){
      const tr=document.createElement('tr');
      const chip = r.within_24h ? '<span class="chip">ephemeral</span>'
                                : '<span class="chip">kept</span>';
      const btnTxt = r.within_24h ? 'Keep' : 'Make ephemeral';
      tr.innerHTML = `
       <td>${r.server_received_at? new Date(r.server_received_at).toLocaleString():''}</td>
       <td>${r.filename}</td>
       <td>${fmt(r.size_bytes)}</td>
       <td>${r.content_type||''}</td>
       <td>${r.get_url? '<a href="'+r.get_url+'">download</a>':''}</td>
       <td>${chip}</td>
       <td>
         <button onclick="toggleKeep('${r.id}', ${r.within_24h})">${btnTxt}</button>
         <button onclick="delFile('${r.id}')">Delete</button>
       </td>`;
      tb.appendChild(tr);
    }
  }catch(e){ document.getElementById('err').textContent='Fehler: '+e.message; }
}

async function delFile(id){
  if(!confirm('Wirklich lÃ¶schen?')) return;
  const res = await fetch('http://localhost:8081/files/'+id, {method:'DELETE'});
  if(!res.ok){ alert('Delete fehlgeschlagen: HTTP '+res.status); return; }
  await load();
}

async function toggleKeep(id, currentWithin24h){
  const body = JSON.stringify({ within_24h: !currentWithin24h });
  const res = await fetch('http://localhost:8081/files/'+id+'/retention', {
    method:'PATCH', headers:{'Content-Type':'application/json'}, body
  });
  if(!res.ok){ alert('Retention-Update fehlgeschlagen: HTTP '+res.status); return; }
  await load();
}

load();
</script>


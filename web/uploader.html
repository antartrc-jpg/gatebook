<!doctype html>
<meta charset="utf-8"/>
<title>Gatebook â€“ Mini Uploader</title>
<style>
  body{font-family:system-ui;margin:2rem}
  h1{margin:0 0 1rem}
  button{padding:.3rem .7rem}
  #log{white-space:pre-wrap;font-family:ui-monospace,monospace;margin-top:1rem}
  .ok{color:#177245}.err{color:#a00}
</style>
<h1>Gatebook â€“ Mini Uploader</h1>

<section style="display:flex;gap:1rem;align-items:center;margin:.5rem 0 1.5rem">
  <input id="file" type="file"/>
  <label style="display:flex;gap:.4rem;align-items:center">
    <input id="keep" type="checkbox"> Keep (nicht automatisch lÃ¶schen)
  </label>
  <button id="btn" onclick="doUpload()">Upload</button>
  <a href="http://localhost:5173/files.html" target="_blank">Recent Files Ã¶ffnen</a>
</section>

<div id="log"></div>

<script>
const log = (msg, cls="") => {
  const d=document.getElementById("log");
  const p=document.createElement("div");
  if(cls) p.className=cls;
  p.textContent=msg;
  d.appendChild(p);
};

async function sha256Hex(file){
  const buf = await file.arrayBuffer();
  const hash = await crypto.subtle.digest("SHA-256", buf);
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function doUpload(){
  const f = document.getElementById("file").files[0];
  const keep = document.getElementById("keep").checked;
  if(!f){ alert("Bitte Datei wÃ¤hlen"); return; }
  document.getElementById("log").innerHTML="";
  const btn = document.getElementById("btn"); btn.disabled = true;

  try{
    log(`Datei: ${f.name} (${f.type||"application/octet-stream"}, ${f.size} bytes)`);

    // 1) presign
    log("presign â€¦");
    const body = JSON.stringify({ filename:f.name, content_type:(f.type||"application/octet-stream"), size_bytes:f.size });
    const pres = await fetch("http://localhost:8081/files/presign", {
      method:"POST", headers:{ "Content-Type":"application/json" }, body
    }).then(r=>{ if(!r.ok) throw new Error("presign HTTP "+r.status); return r.json(); });

    // 2) PUT nach MinIO â€“ Content-Type MUSS exakt passen
    log("upload (PUT) â€¦");
    await fetch(pres.url, {
      method:"PUT",
      headers: { "Content-Type": (f.type||"application/octet-stream") },
      body: f
    }).then(r=>{ if(!r.ok) throw new Error("PUT HTTP "+r.status); });

    // 3) confirm (inkl. Hash)
    log("hash â€¦");
    const sha = await sha256Hex(f);
    log("confirm â€¦");
    await fetch("http://localhost:8081/files/confirm", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ file_id: pres.file_id, sha256_hex: sha })
    }).then(r=>{ if(!r.ok) throw new Error("confirm HTTP "+r.status); });

    // optional: Keep
    if(keep){
      log("keep setzen â€¦");
      await fetch(`http://localhost:8081/files/${pres.file_id}/retention`, {
        method:"PATCH",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ within_24h: false })
      }).then(r=>{ if(!r.ok) throw new Error("retention HTTP "+r.status); });
    }

    log("fertig âœ“", "ok");
    log("â†’ Ã–ffne Recent Files, dort sollte der Eintrag erscheinen.", "ok");
    window.open("http://localhost:5173/files.html", "_blank");
  } catch(e){
    log("Fehler: "+e.message, "err");
    log("Bitte F12 (Entwicklertools) â†’ Reiter 'Network' prÃ¼fen und die rote Zeile anklicken.", "err");
  } finally {
    btn.disabled = false;
  }
}
</script>

